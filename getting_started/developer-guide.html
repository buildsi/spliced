<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Guide &mdash; Spliced 0.0.17 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx-argparse.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="spliced package" href="../api_reference/spliced.html" />
    <link rel="prev" title="User Guide" href="user-guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Spliced
          </a>
              <div class="version">
                0.0.17
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-guide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#design-of-spliced">Design of Spliced</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#spack-experiment-runner">Spack Experiment Runner</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#add-an-experiment">Add An Experiment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-a-predictor">Add A Predictor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#develop-with-docker">Develop with Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-container-base">Creating a container base</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/spliced.html">spliced package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/internal/modules.html">Internal API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spliced</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Getting Started</a> &raquo;</li>
      <li>Developer Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/getting_started/developer-guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-guide">
<span id="getting-started-developer-guide"></span><h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Permalink to this heading"></a></h1>
<p>This developer guide includes more complex interactions like adding experiments
or using containers. If you haven’t read <a class="reference internal" href="installation.html#getting-started-installation"><span class="std std-ref">Installation</span></a>
you should do that first.</p>
<section id="design-of-spliced">
<h2>Design of Spliced<a class="headerlink" href="#design-of-spliced" title="Permalink to this heading"></a></h2>
<p>As a reminder, spiced works by having <strong>experiment runners</strong> (e.g., spack) that present a splice object with metadata about libraries to a <strong>predictor</strong> to parse (and make predictions for). This design section will include details for how the experiment runner and subsequent predictors work.</p>
<section id="spack-experiment-runner">
<h3>Spack Experiment Runner<a class="headerlink" href="#spack-experiment-runner" title="Permalink to this heading"></a></h3>
<p>The spack experiment runner works by starting with a main library (e.g., caliper) and a dependency of interest (e.g., papi). We then, for each version of the depedency:</p>
<ol class="arabic simple">
<li><p>Perform a splice of the new version into the main package to derive a new spliced directory.</p></li>
<li><p>Find libs and binaries within the new (spliced) package install (and the original)</p></li>
<li><p>Use <a class="reference external" href="https://vsoch.github.io/elfcall">Elfcall</a> to emulate the linker and find paths of libraries with needed (undefined) symbols.</p></li>
<li><p>Present the elfcall output to each predictor to use appropriately.</p></li>
</ol>
<p>In the case of a “diff” comparator like libabigail or the symbols predictor, we match names of libraries that are used for each of the original dependency (A) and spliced dependency (B) case.</p>
<p>In the case of smeagle, we first check if elfcall didn’t find any symbols, and if so we stop and report failure. The smeagle model depends on function symbol names and will always fail if a symbol is entirely missing. If we found all our symbols, we then
derive first smeagle json (saved to a cache based on the library name) and
then a scoped set of asp facts the main library (A) and the entire set of dependencies (under the namespace B) to compare to. Since elfcall only matches one library to one symbol, there won’t be conflicts within the B space.</p>
<p><strong>Note</strong> that elfcall can only parse ELF. A library or binary that is not ELF cannot be included, and this is a small set but still represents a limitation of the analysis.</p>
</section>
</section>
<section id="add-an-experiment">
<h2>Add An Experiment<a class="headerlink" href="#add-an-experiment" title="Permalink to this heading"></a></h2>
<p>The core of an experiment is to be able to run the initial steps for a splice,
and return the splice object, which should have binaries and libraries for a spec pre and post splice,
along with other metadata. This general format allows us to have an experiment runner like spack
(that will install what we need and then set the paths) or eventually a manual runner (where we can just
set them arbitrarily to our liking).</p>
</section>
<section id="add-a-predictor">
<h2>Add A Predictor<a class="headerlink" href="#add-a-predictor" title="Permalink to this heading"></a></h2>
<p>A predictor should be added as a module to <code class="docutils literal notranslate"><span class="pre">spliced/predict</span></code> so it is retrieved
on init. It should have a main function, predict, which takes a splice object and optional kwargs.
At this point you can iterate through the splice structure to use whatever metadata you need. The splice metadata is derived from <a href="#id1"><span class="problematic" id="id2">`Elfcall _&lt;https://vsoch.github.io/elfcall&gt;`_</span></a> which should have all the sets of libraries found and symbols for each (and we stop when all needed and undefined symbols are found). E.g.,:</p>
<blockquote>
<div><ul class="simple">
<li><p>splice.original: includes original library paths</p></li>
<li><p>splice.spliced: includes spliced library paths</p></li>
</ul>
</div></blockquote>
<p>And you can use the timing function wrappers in the <code class="docutils literal notranslate"><span class="pre">base.py</span></code> under predict to ensure your predictor is timed.
Importantly, your predictor should set <code class="docutils literal notranslate"><span class="pre">spliced.predictions[&lt;name_of_predictor&gt;]</span></code> to be a list of dictionaries,
where you can put any needed metadata. The binary/lib is suggested, along with a return code or message from the console,
and <em>importantly</em> you should have a boolean true/false for “prediction” about whether the splice is predicted to work.
Here is an example list of results (with a single splice prediction using abicompat) from libaibgail.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="s2">&quot;libabigail&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;return_code&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/vanessa/Desktop/Code/spack-vsoch/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/curl-7.50.2-7ybfviq4uauvq4hhggxn3npc6ib4clr3/bin/curl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lib&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/vanessa/Desktop/Code/spack-vsoch/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/zlib-1.2.11-3kmnsdv36qxm3slmcyrb326gkghsp6px/lib/libz.so.1.2.11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;original_lib&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/vanessa/Desktop/Code/spack-vsoch/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/zlib-1.2.11-3kmnsdv36qxm3slmcyrb326gkghsp6px/lib/libz.so.1.2.11&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prediction&quot;</span><span class="p">:</span> <span class="n">true</span>
    <span class="p">}</span>
<span class="p">],</span>
</pre></div>
</div>
<p>To be clear, the predictor must save a list of predictions to the splice.predicitions, keyed by the name, and the following fields are requried:</p>
<blockquote>
<div><ul class="simple">
<li><p>binary</p></li>
<li><p>lib</p></li>
<li><p>prediction</p></li>
</ul>
</div></blockquote>
<p>The following fields are not required but suggested:</p>
<blockquote>
<div><ul class="simple">
<li><p>message (the terminal output of running the predictor)</p></li>
<li><p>return_code</p></li>
<li><p>original_lib or original_binary if relevant for the command</p></li>
<li><p>any other relevant results information</p></li>
</ul>
</div></blockquote>
</section>
<section id="develop-with-docker">
<h2>Develop with Docker<a class="headerlink" href="#develop-with-docker" title="Permalink to this heading"></a></h2>
<p>You can easily build a docker container in the present working directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker build -t spliced .
</pre></div>
</div>
<p>And then shell in, binding code so we can install from there.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker run -it --entrypoint bash -v <span class="nv">$PWD</span>:/code spliced
</pre></div>
</div>
<p>Install locally:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pip install -e .
</pre></div>
</div>
<p>And try generating and running a command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>spliced <span class="nb">command</span> examples/sqlite.yaml
<span class="go">...</span>
<span class="gp">$ </span>spliced splice --package sqlite@3.35.4 --splice zlib --runner spack --replace zlib --experiment sqlite sqlite3 -version
<span class="go">pkg-sqlite@3.35.5-splice-zlib-with-zlib-experiment-sqlite-splices.json is valid! 😂️</span>
</pre></div>
</div>
</section>
<section id="creating-a-container-base">
<h2>Creating a container base<a class="headerlink" href="#creating-a-container-base" title="Permalink to this heading"></a></h2>
<p>Typically, a container base should have the dependencies that you need to run your
splice. E.g., if you want to use the libabigial splicer, libabigail should
be installed. We provide a set of automated builds for containers to provide the software
needed [here](docker) (e.g., including libabigail, spack, and symbols) so you can use this container set,
or if you choose, bootstrap these containers for your own customization. Note that for these containers:</p>
<blockquote>
<div><ul class="simple">
<li><p>we provide several os bases - the default of the spliced execuable is ubuntu 20.04, and you can change this with <cite>–container</cite></p></li>
<li><p>the containers are flagged with [spack labels](<a class="reference external" href="https://github.com/spack/label-schema">https://github.com/spack/label-schema</a>) for <cite>org.spack.compilers</cite> to be discovered by the tool. If you don’t provide labels, all compilers in the container will be used.</p></li>
<li><p>it’s assumed you have software you need in the container, or use our container bases as testing CI bases and install there on the fly.</p></li>
</ul>
</div></blockquote>
<p>If you want to use the default containers provided by spliced, you shouldn’t need to worry about this.
If you have any questions, don’t hesitate to open an issue.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user-guide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api_reference/spliced.html" class="btn btn-neutral float-right" title="spliced package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Vanessa Sochat.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>